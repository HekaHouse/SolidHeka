<!DOCTYPE html>
<html >
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>Account Setup</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="shortcut icon" type="img/png" href="favicon.png">
    <script type="text/javascript" src="bower_components/pkijs/org/pkijs/common.js"></script>
    <script type="text/javascript" src="bower_components/pkijs/org/pkijs/asn1.js"></script>
    <script type="text/javascript" src="bower_components/pkijs/org/pkijs/x509_schema.js"></script>
    <script type="text/javascript" src="bower_components/pkijs/org/pkijs/x509_simpl.js"></script>
    <script type="text/javascript">
        //*********************************************************************************
        // #region Auxiliary functions 
        //*********************************************************************************
        function formatPEM(pem_string)
        {
            /// <summary>Format string in order to have each line with length equal to 63</summary>
            /// <param name="pem_string" type="String">String to format</param>

            var string_length = pem_string.length;
            var result_string = "";

            for(var i = 0, count = 0; i < string_length; i++, count++)
            {
                if(count > 63)
                {
                    result_string = result_string + "\r\n";
                    count = 0;
                }

                result_string = result_string + pem_string[i];
            }

            return result_string;
        }
        //*********************************************************************************
        function arrayBufferToString(buffer)
        {
            /// <summary>Create a string from ArrayBuffer</summary>
            /// <param name="buffer" type="ArrayBuffer">ArrayBuffer to create a string from</param>

            var result_string = "";
            var view = new Uint8Array(buffer);

            for(var i = 0; i < view.length; i++)
                result_string = result_string + String.fromCharCode(view[i]);

            return result_string;
        }
        //*********************************************************************************
        function stringToArrayBuffer(str)
        {
            /// <summary>Create an ArrayBuffer from string</summary>
            /// <param name="str" type="String">String to create ArrayBuffer from</param>

            var stringLength = str.length;

            var resultBuffer = new ArrayBuffer(stringLength);
            var resultView = new Uint8Array(resultBuffer);

            for(var i = 0; i < stringLength; i++)
                resultView[i] = str.charCodeAt(i);

            return resultBuffer;
        }
        //*********************************************************************************
        // #endregion 
        //*********************************************************************************
        // #region Create PKCS#10 
        //*********************************************************************************
        function create_PKCS10()
        {
            // #region Initial variables 
            var sequence = Promise.resolve();

            var pkcs10_simpl = new org.pkijs.simpl.PKCS10();

            var publicKey;
            var privateKey;

            var hash_algorithm;
            var hash_option = "alg_SHA256";
            switch(hash_option)
            {
                case "alg_SHA1":
                    hash_algorithm = "sha-1";
                    break;
                case "alg_SHA256":
                    hash_algorithm = "sha-256";
                    break;
                case "alg_SHA384":
                    hash_algorithm = "sha-384";
                    break;
                case "alg_SHA512":
                    hash_algorithm = "sha-512";
                    break;
                default:;
            }

            var signature_algorithm_name;
            var sign_option = "alg_RSA2";
            switch(sign_option)
            {
                case "alg_RSA15":
                    signature_algorithm_name = "RSASSA-PKCS1-V1_5";
                    break;
                case "alg_RSA2":
                    signature_algorithm_name = "RSA-PSS";
                    break;
                case "alg_ECDSA":
                    signature_algorithm_name = "ECDSA";
                    break;
                default:;
            }
            // #endregion 

            // #region Get a "crypto" extension 
            var crypto = org.pkijs.getCrypto();
            if(typeof crypto == "undefined")
            {
                alert("No WebCrypto extension found");
                return;
            }
            // #endregion 

            // #region Put a static values 
            pkcs10_simpl.version = 0;
            pkcs10_simpl.subject.types_and_values.push(new org.pkijs.simpl.ATTR_TYPE_AND_VALUE({ type: "2.5.4.6", value: new org.pkijs.asn1.PRINTABLESTRING({ value: "US" }) }));
            pkcs10_simpl.subject.types_and_values.push(new org.pkijs.simpl.ATTR_TYPE_AND_VALUE({ type: "2.5.4.3", value: new org.pkijs.asn1.UTF8STRING({ value: "heka.house" }) }));

            pkcs10_simpl.attributes = new Array();
            // #endregion 

            // #region Create a new key pair 
            sequence = sequence.then(
                function()
                {
                    // #region Get default algorithm parameters for key generation 
                    var algorithm = org.pkijs.getAlgorithmParameters(signature_algorithm_name, "generatekey");
                    if("hash" in algorithm.algorithm)
                        algorithm.algorithm.hash.name = hash_algorithm;
                    // #endregion 

                    return crypto.generateKey(algorithm.algorithm, true, algorithm.usages);
                }
                );
            // #endregion 

            // #region Store new key in an interim variables
            sequence = sequence.then(
                function(keyPair)
                {
                    publicKey = keyPair.publicKey;
                    privateKey = keyPair.privateKey;
                },
                function(error)
                {
                    alert("Error during key generation: " + error);
                }
                );
            // #endregion 

            sequence = sequence.then(
                window.crypto.subtle.importKey(
                    "pkcs8", 
                    privateKey,
                    {   
                        name: "RSASSA-PKCS1-v1_5",
                        hash: {name: "SHA-256"}, 
                    },
                    false, 
                    ["sign"] 
                )
                .then(function(importedKey){
                    privateKey = importedKey;
                })
                .catch(function(err){
                    console.error(err);
                });
              );

            // #region Exporting public key into "subjectPublicKeyInfo" value of PKCS#10 
            sequence = sequence.then(
                function()
                {
                    return pkcs10_simpl.subjectPublicKeyInfo.importKey(publicKey);
                }
                );
            // #endregion 

            // #region SubjectKeyIdentifier 
            sequence = sequence.then(
                function(result)
                {
                    return crypto.digest({ name: "SHA-1" }, pkcs10_simpl.subjectPublicKeyInfo.subjectPublicKey.value_block.value_hex);
                }
                ).then(
                function(result)
                {
                    pkcs10_simpl.attributes.push(new org.pkijs.simpl.ATTRIBUTE({
                        type: "1.2.840.113549.1.9.14", // pkcs-9-at-extensionRequest
                        values: [(new org.pkijs.simpl.EXTENSIONS({
                            extensions_array: [
                                new org.pkijs.simpl.EXTENSION({
                                    extnID: "2.5.29.14",
                                    critical: false,
                                    extnValue: (new org.pkijs.asn1.OCTETSTRING({ value_hex: result })).toBER(false)
                                })
                            ]
                        })).toSchema()]
                    }));
                }
                );
            // #endregion 

            // #region Signing final PKCS#10 request 
            sequence = sequence.then(
                function()
                {
                    return pkcs10_simpl.sign(privateKey, hash_algorithm);
                },
                function(error)
                {
                    alert("Error during exporting public key: " + error);
                }
                );
            // #endregion 

            sequence.then(
                function(result)
                {
                    var pkcs10_schema = pkcs10_simpl.toSchema();
                    var pkcs10_encoded = pkcs10_schema.toBER(false);

                    var result_string = "-----BEGIN CERTIFICATE REQUEST-----\r\n";
                    result_string = result_string + formatPEM(window.btoa(arrayBufferToString(pkcs10_encoded)));
                    result_string = result_string + "\r\n-----END CERTIFICATE REQUEST-----\r\n";

                    document.getElementById("spkacWebID").value = result_string;
                    document.querySelector(".spkacform").setAttribute("action", makeURI(account)+CERT_ENDPOINT);
                    document.querySelector(".spkacform").submit();
                    certDone();
                },
                function(error)
                {
                    alert("Error signing PKCS#10: " + error);
                }
                );
        }
    </script>
  </head>
<body>
	<div id="pickuser" class="account-setup">
		<header>
			<div class="solid center"><img src="images/solid-logo.png"></div>
			<div class="status-progress">
        <div class="progression float-left"></div>
				<div class="clearfix">
					<div class="float-left inline-block"><a class="first-bullet">1<span class="progress-info left">Create your account</span></a></div>
					<div class="inline-block"><a class="second-bullet">2<span class="progress-info middle">Add more information</span></a></a></div>
					<div class="float-right inline-block"><a class="third-bullet">3<span class="progress-info right">Generate keys</span></a></div>
				</div>
			</div> <!-- end status-progress -->
		</header>

    <article class="center">
      <div class="notify successbox">
        <h1>Success!</h1>
        <div class="icon icon-success svg">
          <svg xmlns="http://www.w3.org/2000/svg" width="72px" height="72px">
            <g fill="none" stroke="#43C47A" stroke-width="2">
              <circle cx="36" cy="36" r="35" style="stroke-dasharray:240px, 240px; stroke-dashoffset: 480px;"></circle>
              <path d="M17.417,37.778l9.93,9.909l25.444-25.393" style="stroke-dasharray:50px, 50px; stroke-dashoffset: 0px;"></path>
            </g>
          </svg>
        </div>
        <p class="notifymessage"></p>
      </div>

      <div class="first">
        <form class="pure-form">
          <h2>Welcome to <span class="welcome"></span>!</h2>
          <p>Let's get you set up with an account.</p>
          <a href="#chrome-instructions" id="toggle-chrome-instructions">Using Chrome? Click here</a>
          <div id="chrome-instructions">
            <p>
              If you're using Chrome, you must first enable Key Generation for this page.
            </p>
            <ol>
              <li>Click on the green padlock to the left of the left of the Address Bar.</li>
              <li>Click on "Key Generation", and change the value from "Blocked by default" to "Always allow on this site".</li>
              <li>You're all set!  Go ahead and sign up for Solid.</li>
            </ol>
          </div>
          <input type="text" class="account" name="username" value="" placeholder="Pick a user name" oninput="validateAccount()" autofocus>
          <div class="accountinfo">
            <span class="schema"></span><strong><span class="username"></span></strong>.<span class="domain"></span>
          </div>
          <div class="illegal">
            <small>Only letters, numbers, hyphens (-) and underscores (_) are accepted.</small>
          </div>
          <div class="status"></div>
          <div class="email">
            <input type="email" class="address" name="email" placeholder="Email (optional)">
            <div class="">
              <small>
                Your email address will be used <u>only</u> for account recovery. Without it, you won't be able to recover your account .
              </small>
            </div>
          </div>
        </form>
      </div>

      <div class="second">
        <form>
          <h3>Username reserved...</h3>
          <input type="file" id="inputFileToLoad" class="hidden" onchange="loadImageFileAsURL()">
          <a href='#' onclick="clickFileInput()">
            <div class="camera-wrap">
              <span class='camera'></span>
            </div>
            <img class="profilepic hidden">
          </a>
          <a href="#" onclick="removePicture()">Remove picture</a>
          <input type="text" class="fullname" name="name" value="" placeholder="Type your full name (optional)">
        </form>
      </div>

      <div class="third">
        <form class="spkacform" method="POST" target="spkacframe">
          <input id="spkacWebID" name="spkac" class="hidden"></input>
          <iframe class="hidden" name="spkacframe"></iframe>
          <input type="text" class="webid hidden" name="webid">
          <input type="text" class="certname hidden" name="name" value="" placeholder="Your name">
          <h3>You're almost there!</h3>
          <p class="justify">In this final step, strong cryptographic keys will be generated and installed in the browser. Using them avoids having to remember passwords, thus offerring increased security.</p>
        </form>
      </div>
    </article>

    <footer>
      <div class="buttons center">
        <a href="#" class="createacc button greenbg" onclick="createAccount()">Create account</a>
        <a href="#" class="check button" onclick="checkExists()">Check availability</a>
        <a href="#" class="update button" onclick="updateProfile()">Update profile (or skip)</a>
        <a href="#" class="issue button" onclick="create_PKCS10()">Generate keys and finish</a>
        <a href="#" class="return button" onclick="returnToApp()">Go back to the app</a>
        <a href="#" class="done button" onclick="showAccount()">Take me to my account</a>
      </div>
    </footer>
	</div> <!-- end account setup -->

  <!-- Local Javascript -->
  <script src="js/md5.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
